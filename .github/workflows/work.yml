name: GitHub Actions maxi
run-name: ${{ github.actor }} is testing out GitHub Actions üöÄ
on: [push]
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:  
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - name: installation
        run: "pip install --quiet --upgrade --requirement requirements.txt"
      - name: lintage
        run: |
          flake8 --ignore=E501,E231 *.py
          pylint --errors-only --disable=C0301 --disable=C0326 *.py

  build:  # Nom du job
      needs: [lint]  # D√©pend du job `lint`
      runs-on: ubuntu-latest  # S'ex√©cute sur la derni√®re version d'Ubuntu
      permissions:  # Permissions n√©cessaires
        packages: write  # Autorisation d'√©crire aux packages

      # √âtapes du job
      steps:
        - name: code checkout  # R√©cup√®re le code source
          uses: actions/checkout@v4  # Utilise l'action GitHub pour le checkout

        - name: setup Buildx  # Configure Docker Buildx
          uses: docker/setup-buildx-action@v3  # Utilise l'action Buildx

        - name: login to GitHub Package Registry  # Connexion √† GitHub Container Registry
          uses: docker/login-action@v3  # Utilise l'action de login Docker
          with:  # Avec ces param√®tres
            username: ${{ github.actor }}  # Nom d'utilisateur GitHub
            password: ${{ secrets.DOCKER_TOKEN }}  # `GITHUB_TOKEN` pour l'authentification

        - name: get metadata  # R√©cup√®re les m√©tadonn√©es pour Docker
          id: metadata  # ID pour cette √©tape
          uses: docker/metadata-action@v5  # Utilise l'action de m√©tadonn√©es
          with:
            images: ghcr.io/${{ github.repository }}/  # Utilise le nom dur repository
            
        - name: Get current date # get the date of the build
          id: date
          run: echo "::set-output name=date::$(date +'%Y-%m-%d--%M-%S')"
                       
        - name: build and push  # Construit et pousse l'image
          uses: docker/build-push-action@v5  # Utilise l'action de build et push Docker
          with:  # Avec ces param√®tres
            push: true  # Pousse l'image
            tags: docker.io/dockerisateur/flask-docker:${{ steps.date.outputs.date }}  # Tags pour l'image
            context: .  # Contexte pour la construction Docker
            cache-from: type=gha  # Utilise le cache GitHub Actions
            cache-to: type=gha,mode=max  # Enregistre le cache pour les utilisations futures
